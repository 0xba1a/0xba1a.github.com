
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Bala">
      
      
        <link rel="canonical" href="https://eastrivervillage.com/blog/page/10/">
      
      
        <link rel="prev" href="../../..">
      
      
        <link rel="next" href="../../tags/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../images/fabicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Blog - East River Village</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-3JJ45DK8YN"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-3JJ45DK8YN",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-3JJ45DK8YN",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#blog" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://eastrivervillage.com" title="East River Village" class="md-header__button md-logo" aria-label="East River Village" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            East River Village
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Blog
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m3.55 19.09 1.41 1.41 1.8-1.79-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71 1.8 1.79 1.41-1.41-1.79-1.8M20.45 5l-1.41-1.4-1.8 1.79 1.42 1.42M13 1h-2v3h2M6.76 5.39 4.96 3.6 3.55 5l1.79 1.81zM1 13h3v-2H1m12 9h-2v3h2"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07zm-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13zm-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87zM19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35zm4.33-2.7 1.15-2.77 2.2 2.54zm1.15-4.96-1.14-2.78 3.34.24zM9.63 18.93l2.77 1.15-2.53 2.19z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://eastrivervillage.com" title="East River Village" class="md-nav__button md-logo" aria-label="East River Village" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>

    </a>
    East River Village
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    September 2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    July 2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    November 2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    June 2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    October 2018
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.41 7.41 15 12l-4.59 4.6L9 15.18 12.18 12 9 8.82M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
  
  <span class="md-ellipsis">
    September 2017
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kexec-a-travel-to-the-purgatory" class="md-nav__link">
    <span class="md-ellipsis">
      kexec - A travel to the purgatory
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="blog">Blog</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="../../../assets/author_image.jpg" alt="Bala">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-20 17:35:13+00:00">January 20, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              11 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kexec-a-travel-to-the-purgatory"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/">kexec - A travel to the purgatory</a></h2>
<p>This is one of the unforgettable experience in my engineering life. Last year when we brought-up a ARM64 based platform, we faced lots of hurdles. But this one was very interesting and had lots of surprises. Though this triaging effort tolled multiple frustrating days, I had very good learning. I had to understand <code>kexec_load</code> system call, kernel reboot path and kernel early boot path to root cause the issue. We were using 4.14.19 kernel for the bring-up. But I'll give code samples from 5.4.14 as it is latest. There is no much code difference.</p>
<p>The boot flow of our new platform was <code>uboot --&gt; service Linux --&gt; main Linux</code>. We had <code>service Linux</code> to offload major hardware initialization work from the bootloader. Also to keep that code platform agnostic [same <code>service Linux</code> ran on x86 platforms too].</p>
<p>To make the jump from <code>service Linux</code> to <code>main Linux</code> we used <code>kexec</code>. The problem here was it took almost 2 minutes for the <code>main Linux</code> to start booting. This was a significant difference while comparing with x86 platforms. And this kind of delay would definitely annoy our customers.</p>
<p>After hundreds of rebuilds and thousands of print statements, I found the cause and fixed the issue. Now that 2 minutes delay was reduced to 4 seconds. Let me just tell you the code flow rather dump you with my debugging methods. I kept deferring from writing this article for almost an year. Because I was afraid of the code references and connecting them to show the flow.</p>
<h2 id="code-reference"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#code-reference">Code reference</a></h2>
<table>
<thead>
<tr>
<th>package</th>
<th>version</th>
<th>repo</th>
</tr>
</thead>
<tbody>
<tr>
<td>kexec-tools</td>
<td>today's latest master 2c9f26ed20a791a7df0182ba82e93abb52f5a615</td>
<td>https://github.com/horms/kexec-tools</td>
</tr>
<tr>
<td>linux</td>
<td>5.4.14</td>
<td>https://elixir.bootlin.com/linux/v5.4.14/source</td>
</tr>
</tbody>
</table>
<div style="color:#3273dc">
<span style="font-weight: bold;">NOTE:</span> I copied code of entire functions for reference. But explained only necessary lines for better understanding.
</div>

<h2 id="user-story"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#user-story">User story</a></h2>
<p>Login to the <code>service Linux</code>. Load <code>main Linux</code>'s kernel and initrd. The current <code>device-tree</code> will be taken for <code>main Linux</code> too. Boot to <code>main Linux</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># kexec -l /main/vmlinuz --initrd=/main/initrd.img</span>
<span class="c1"># kexec -e</span>
</code></pre></div>
<p>As I mentioned earlier there was 2 mins delay between last <code>Bye</code> from <code>service Linux</code> and first message from <code>main Linux</code>. So I started looking for time consuming operations between those two prints.</p>
<h2 id="kexec-tools-kexec-e"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#kexec-tools-kexec-e">kexec-tools <code>kexec -e</code></a></h2>
<p><code>kexec -e</code> calls <code>reboot()</code> system call with <code>LINUX_REBOOT_CMD_KEXEC</code> as argument.
<div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">my_exec</span><span class="w"> </span><span class="o">+</span><span class="mi">900</span><span class="o">:</span>
<span class="o">---</span>
<span class="n">reboot</span><span class="p">(</span><span class="n">LINUX_REBOOT_CMD_KEXEC</span><span class="p">);</span>
</code></pre></div>
<br/></p>
<h2 id="kernel-reboot-path"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#kernel-reboot-path">Kernel reboot path</a></h2>
<h4 id="reboot-system-call"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#reboot-system-call">reboot system call</a></h4>
<p>Reboot system call calls <code>kernel_kexec()</code> for the argument <code>LINUX_REBOOT_CMD_KEXEC</code>. You can refer to my earlier article <a href="http://eastrivervillage.com/Anatomy-of-Linux-system-call-in-ARM64/">Anatomy of Linux system call in ARM64</a> to understand how arguments are passed from user space to kernel space.
<div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">reboot</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">reboot</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="o">+</span><span class="mi">380</span><span class="o">:</span>
<span class="o">---</span>
<span class="cp">#ifdef CONFIG_KEXEC_CORE</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">LINUX_REBOOT_CMD_KEXEC</span><span class="p">:</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_kexec</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
</code></pre></div></p>
<h4 id="kernel_kexec"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#kernel_kexec">kernel_kexec()</a></h4>
<p><code>kernel_kexec()</code> at <code>kernel/kexec_core.c +1119</code> does following things.
<div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">kexec_core</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="mi">1119</span>
<span class="o">---</span>
<span class="cm">/*</span>
<span class="cm"> * Move into place and start executing a preloaded standalone</span>
<span class="cm"> * executable.  If nothing was preloaded return an error.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="n">kernel_kexec</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_mutex</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kexec_image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">Unlock</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#ifdef CONFIG_KEXEC_JUMP</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kexec_image</span><span class="o">-&gt;</span><span class="n">preserve_context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock_system_sleep</span><span class="p">();</span>
<span class="w">        </span><span class="n">pm_prepare_console</span><span class="p">();</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">freeze_processes</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">Restore_console</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">suspend_console</span><span class="p">();</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dpm_suspend_start</span><span class="p">(</span><span class="n">PMSG_FREEZE</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">Resume_console</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/* At this point, dpm_suspend_start() has been called,</span>
<span class="cm">         * but *not* dpm_suspend_end(). We *must* call</span>
<span class="cm">         * dpm_suspend_end() now.  Otherwise, drivers for</span>
<span class="cm">         * some devices (e.g. interrupt controllers) become</span>
<span class="cm">         * desynchronized with the actual state of the</span>
<span class="cm">         * hardware at resume time, and evil weirdness ensues.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dpm_suspend_end</span><span class="p">(</span><span class="n">PMSG_FREEZE</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">Resume_devices</span><span class="p">;</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">suspend_disable_secondary_cpus</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">Enable_cpus</span><span class="p">;</span>
<span class="w">        </span><span class="n">local_irq_disable</span><span class="p">();</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syscore_suspend</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">Enable_irqs</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">kexec_in_progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">kernel_restart_prepare</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">migrate_to_reboot_cpu</span><span class="p">();</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * migrate_to_reboot_cpu() disables CPU hotplug assuming that</span>
<span class="cm">         * no further code needs to use CPU hotplug (which is true in</span>
<span class="cm">         * the reboot case). However, the kexec path depends on using</span>
<span class="cm">         * CPU hotplug again; so re-enable it here.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">cpu_hotplug_enable</span><span class="p">();</span>
<span class="w">        </span><span class="n">pr_emerg</span><span class="p">(</span><span class="s">&quot;Starting new kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">machine_shutdown</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">machine_kexec</span><span class="p">(</span><span class="n">kexec_image</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_KEXEC_JUMP</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kexec_image</span><span class="o">-&gt;</span><span class="n">preserve_context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">syscore_resume</span><span class="p">();</span>
<span class="w"> </span><span class="nl">Enable_irqs</span><span class="p">:</span>
<span class="w">        </span><span class="n">local_irq_enable</span><span class="p">();</span>
<span class="w"> </span><span class="nl">Enable_cpus</span><span class="p">:</span>
<span class="w">        </span><span class="n">suspend_enable_secondary_cpus</span><span class="p">();</span>
<span class="w">        </span><span class="n">dpm_resume_start</span><span class="p">(</span><span class="n">PMSG_RESTORE</span><span class="p">);</span>
<span class="w"> </span><span class="nl">Resume_devices</span><span class="p">:</span>
<span class="w">        </span><span class="n">dpm_resume_end</span><span class="p">(</span><span class="n">PMSG_RESTORE</span><span class="p">);</span>
<span class="w"> </span><span class="nl">Resume_console</span><span class="p">:</span>
<span class="w">        </span><span class="n">resume_console</span><span class="p">();</span>
<span class="w">        </span><span class="n">thaw_processes</span><span class="p">();</span>
<span class="w"> </span><span class="nl">Restore_console</span><span class="p">:</span>
<span class="w">        </span><span class="n">pm_restore_console</span><span class="p">();</span>
<span class="w">        </span><span class="n">unlock_system_sleep</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="w"> </span><span class="nl">Unlock</span><span class="p">:</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<table>
<thead>
<tr>
<th>line</th>
<th>code</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>1123</td>
<td><code>mutex_trylock(&amp;kexec_mutex)</code></td>
<td>This lock is held to avoid multiple entrance into kexec</td>
</tr>
<tr>
<td>1131</td>
<td><code>if (kexec_image-&gt;preserve_context) {</code></td>
<td>Something related to keep the device status not disturbed during kexec. We were not using it. Moving to else part.</td>
</tr>
<tr>
<td>1165</td>
<td><code>migrate_to_reboot_cpu()</code></td>
<td>Continue execution from logical CPU 0. Only one control path is valid during reboot and startup. That will be executed from CPU-0.</td>
</tr>
<tr>
<td>1175</td>
<td><code>machine_shutdown()</code></td>
<td>Don't get confused by the name of this function. Its just a wrapper around <code>disable_nonboot_cpus()</code> in arm64. It does nothing but disables other CPUs</td>
</tr>
<tr>
<td>1178</td>
<td><code>machine_kexec(kexec_image)</code></td>
<td>Execution continues passing <code>kexec_image</code> as argument. This call should not return.</td>
</tr>
</tbody>
</table>
<h4 id="machine_kexec"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#machine_kexec">machine_kexec()</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">machine_kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="mi">144</span>
<span class="o">---</span>
<span class="cm">/**</span>
<span class="cm"> * machine_kexec - Do the kexec reboot.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from the core kexec code for a sys_reboot with LINUX_REBOOT_CMD_KEXEC.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="n">machine_kexec</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kimage</span><span class="w"> </span><span class="o">*</span><span class="n">kimage</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">reboot_code_buffer_phys</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">reboot_code_buffer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">in_kexec_crash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kimage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kexec_crash_image</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">stuck_cpus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpus_are_stuck_in_kernel</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * New cpus may have become stuck_in_kernel after we loaded the image.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">in_kexec_crash</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">stuck_cpus</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">num_online_cpus</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)));</span>
<span class="w">    </span><span class="n">WARN</span><span class="p">(</span><span class="n">in_kexec_crash</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">stuck_cpus</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">smp_crash_stop_failed</span><span class="p">()),</span>
<span class="w">        </span><span class="s">&quot;Some CPUs may be stale, kdump will be unreliable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">reboot_code_buffer_phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page_to_phys</span><span class="p">(</span><span class="n">kimage</span><span class="o">-&gt;</span><span class="n">control_code_page</span><span class="p">);</span>
<span class="w">    </span><span class="n">reboot_code_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">reboot_code_buffer_phys</span><span class="p">);</span>

<span class="w">    </span><span class="n">kexec_image_info</span><span class="p">(</span><span class="n">kimage</span><span class="p">);</span>

<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: control_code_page:        %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span>
<span class="w">        </span><span class="n">kimage</span><span class="o">-&gt;</span><span class="n">control_code_page</span><span class="p">);</span>
<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: reboot_code_buffer_phys:  %pa</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">reboot_code_buffer_phys</span><span class="p">);</span>
<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: reboot_code_buffer:       %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span>
<span class="w">        </span><span class="n">reboot_code_buffer</span><span class="p">);</span>
<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: relocate_new_kernel:      %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span>
<span class="w">        </span><span class="n">arm64_relocate_new_kernel</span><span class="p">);</span>
<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: relocate_new_kernel_size: 0x%lx(%lu) bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span><span class="w"> </span><span class="n">arm64_relocate_new_kernel_size</span><span class="p">,</span>
<span class="w">        </span><span class="n">arm64_relocate_new_kernel_size</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Copy arm64_relocate_new_kernel to the reboot_code_buffer for use</span>
<span class="cm">     * after the kernel is shut down.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">reboot_code_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">arm64_relocate_new_kernel</span><span class="p">,</span>
<span class="w">        </span><span class="n">arm64_relocate_new_kernel_size</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Flush the reboot_code_buffer in preparation for its execution. */</span>
<span class="w">    </span><span class="n">__flush_dcache_area</span><span class="p">(</span><span class="n">reboot_code_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">arm64_relocate_new_kernel_size</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Although we&#39;ve killed off the secondary CPUs, we don&#39;t update</span>
<span class="cm">     * the online mask if we&#39;re handling a crash kernel and consequently</span>
<span class="cm">     * need to avoid flush_icache_range(), which will attempt to IPI</span>
<span class="cm">     * the offline CPUs. Therefore, we must use the __* variant here.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">__flush_icache_range</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">reboot_code_buffer</span><span class="p">,</span>
<span class="w">                 </span><span class="n">arm64_relocate_new_kernel_size</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Flush the kimage list and its buffers. */</span>
<span class="w">    </span><span class="n">kexec_list_flush</span><span class="p">(</span><span class="n">kimage</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Flush the new image if already in place. */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">kimage</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">kexec_crash_image</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">kimage</span><span class="o">-&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IND_DONE</span><span class="p">))</span>
<span class="w">        </span><span class="n">kexec_segment_flush</span><span class="p">(</span><span class="n">kimage</span><span class="p">);</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bye!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">local_daif_mask</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * cpu_soft_restart will shutdown the MMU, disable data caches, then</span>
<span class="cm">     * transfer control to the reboot_code_buffer which contains a copy of</span>
<span class="cm">     * the arm64_relocate_new_kernel routine.  arm64_relocate_new_kernel</span>
<span class="cm">     * uses physical addressing to relocate the new image to its final</span>
<span class="cm">     * position and transfers control to the image entry point when the</span>
<span class="cm">     * relocation is complete.</span>
<span class="cm">     * In kexec case, kimage-&gt;start points to purgatory assuming that</span>
<span class="cm">     * kernel entry and dtb address are embedded in purgatory by</span>
<span class="cm">     * userspace (kexec-tools).</span>
<span class="cm">     * In kexec_file case, the kernel starts directly without purgatory.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">cpu_soft_restart</span><span class="p">(</span><span class="n">reboot_code_buffer_phys</span><span class="p">,</span><span class="w"> </span><span class="n">kimage</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">kimage</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_KEXEC_FILE</span>
<span class="w">                        </span><span class="n">kimage</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtb_mem</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">                        </span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">BUG</span><span class="p">();</span><span class="w"> </span><span class="cm">/* Should never get here. */</span>
<span class="p">}</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>line</th>
<th>code</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>148</td>
<td><code>bool in_kexec_crash = (kimage == kexec_crash_image)</code></td>
<td>Not true in our case. <code>kimage</code> is <code>kexec_image</code></td>
</tr>
<tr>
<td>149</td>
<td><code>bool stuck_cpus = cpus_are_stuck_in_kernel();</code></td>
<td>Get number of stuck CPUs. Ideally it should be 0</td>
</tr>
<tr>
<td>154</td>
<td><code>BUG_ON(!in_kexec_crash &amp;&amp; (stuck_cpus &#124;&#124; (num_online_cpus() &gt; 1)))</code></td>
<td>In non-crash situations, no CPU should be stuck and no CPU other than reboot CPU should be online.</td>
</tr>
<tr>
<td>158</td>
<td><code>reboot_code_buffer_phys = page_to_phys(kimage-&gt;control_code_page)</code></td>
<td>Get the physical page address from <code>kimage-&gt;control_code_page</code>. <code>arm64_relocate_new_kernel</code> function will be copied to this special location.</td>
</tr>
<tr>
<td>159</td>
<td><code>reboot_code_buffer = phys_to_virt(reboot_code_buffer_phys)</code></td>
<td>Store the virtual address of same to continue working on that area.</td>
</tr>
<tr>
<td>179</td>
<td><code>memcpy(reboot_code_buffer, arm64_relocate_new_kernel, arm64_relocate_new_kernel_size)</code></td>
<td>Copies <code>arm64_relocate_new_kernel_size</code> routines address to the jump location. It is implemented in assembly. This is the routine that copies new kernel to its correct place. To make sure the memory where this routine resides doesn't get overwritten during the copy, it is copied inside <code>kexec_image</code> and executed from there. Never expected right? me too.</td>
</tr>
<tr>
<td>183 - 199</td>
<td><code>__flush_dcache_area(reboot_code_buffer, arm64_relocate_new_kernel_size);</code><br/><code>__flush_icache_range((uintptr_t)reboot_code_buffer, arm64_relocate_new_kernel_size);</code><br/><code>kexec_list_flush(kimage);if ((kimage != kexec_crash_image) &amp;&amp; (kimage-&gt;head &amp; IND_DONE)) kexec_segment_flush(kimage);</code></td>
<td>Flush necessary memory areas</td>
</tr>
<tr>
<td>201</td>
<td><code>pr_info("Bye!\n")</code></td>
<td><b>The last print message from current kernel</b></td>
</tr>
<tr>
<td>203</td>
<td><code>local_daif_mask()</code></td>
<td>Disable all exceptions including interrupts. As we are entering into reboot path, don't expect any normal operations.</td>
</tr>
<tr>
<td>217</td>
<td><code>cpu_soft_restart(reboot_code_buffer_phys, kimage-&gt;head, kimage-&gt;start,0)</code></td>
<td>This call won't return. <code>CONFIG_KEXEC_FILE</code> is not necessary in our case. The comment block above this call explains about purgatory code. But unfortunately that was not written when I was actually debugging this issue.</td>
</tr>
</tbody>
</table>
<h4 id="cpu_soft_restart"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#cpu_soft_restart">cpu_soft_restart()</a></h4>
<p>Its just a wrapper around <code>__cpu_soft_restart</code> which is an assembly routine. <code>el2_switch</code> would be set to 0 in our case.
<div class="highlight"><pre><span></span><code><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">cpu</span><span class="o">-</span><span class="n">reset</span><span class="p">.</span><span class="n">h</span><span class="w"> </span><span class="o">+</span><span class="mi">16</span>
<span class="o">---</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__cpu_soft_restart</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">el2_switch</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg2</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__noreturn</span><span class="w"> </span><span class="nf">cpu_soft_restart</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg2</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">typeof</span><span class="p">(</span><span class="n">__cpu_soft_restart</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">restart</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">el2_switch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">is_kernel_in_hyp_mode</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">is_hyp_mode_available</span><span class="p">();</span>
<span class="w">    </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">__cpu_soft_restart</span><span class="p">);</span>

<span class="w">    </span><span class="n">cpu_install_idmap</span><span class="p">();</span>
<span class="w">    </span><span class="n">restart</span><span class="p">(</span><span class="n">el2_switch</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span><span class="p">);</span>
<span class="w">    </span><span class="n">unreachable</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></p>
<p>An important call to note here is <code>cpu_install_idmap()</code>. This comes handy when MMU comes in or goes out. Linux kernel has a text section called <code>idmap.text</code>. <code>cpu_install_idmap()</code> will copy this section to two memory areas. There will be virtual memory mapping for one of these areas. The second area will be literal physical memory location of the virtual address. For example code in this section will be loaded at physical address 0x0 and 0x80000000. And the virtual address corresponding to 0x80000000 will be 0x0. It ensures continuous execution after MMU goes off. I'll write a separate article explaining in detail about this.</p>
<h4 id="__cpu_soft_restart"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#__cpu_soft_restart">__cpu_soft_restart()</a></h4>
<div class="highlight"><pre><span></span><code><span class="nf">arch</span><span class="err">/</span><span class="no">arm64</span><span class="err">/</span><span class="no">kernel</span><span class="err">/</span><span class="no">cpu-reset.S</span><span class="w"> </span><span class="err">+</span><span class="mi">15</span>
<span class="err">---</span>
<span class="na">.text</span>
<span class="na">.pushsection</span><span class="w">    </span><span class="no">.idmap.text</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;awx&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * __cpu_soft_restart(el2_switch, entry, arg0, arg1, arg2) - Helper for</span>
<span class="cm"> * cpu_soft_restart.</span>
<span class="cm"> *</span>
<span class="cm"> * @el2_switch: Flag to indicate a switch to EL2 is needed.</span>
<span class="cm"> * @entry: Location to jump to for soft reset.</span>
<span class="cm"> * arg0: First argument passed to @entry. (relocation list)</span>
<span class="cm"> * arg1: Second argument passed to @entry.(physical kernel entry)</span>
<span class="cm"> * arg2: Third argument passed to @entry. (physical dtb address)</span>
<span class="cm"> *</span>
<span class="cm"> * Put the CPU into the same state as it would be if it had been reset, and</span>
<span class="cm"> * branch to what would be the reset vector. It must be executed with the</span>
<span class="cm"> * flat identity mapping.</span>
<span class="cm"> */</span>
<span class="nf">ENTRY</span><span class="p">(</span><span class="no">__cpu_soft_restart</span><span class="p">)</span>
<span class="w">    </span><span class="cm">/* Clear sctlr_el1 flags. */</span>
<span class="w">    </span><span class="nf">mrs</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">sctlr_el1</span>
<span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">SCTLR_ELx_FLAGS</span>
<span class="w">    </span><span class="nf">bic</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x13</span>
<span class="w">    </span><span class="nf">pre_disable_mmu_workaround</span>
<span class="w">    </span><span class="nf">msr</span><span class="w"> </span><span class="no">sctlr_el1</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span>
<span class="w">    </span><span class="nf">isb</span>

<span class="w">    </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">f</span><span class="w">              </span><span class="c1">// el2_switch?</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="c1">#HVC_SOFT_RESTART</span>
<span class="w">    </span><span class="nf">hvc</span><span class="w"> </span><span class="mi">#0</span><span class="w">              </span><span class="c1">// no return</span>

<span class="err">1:</span><span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">x18</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w">             </span><span class="c1">// entry</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w">              </span><span class="c1">// arg0</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="w">              </span><span class="c1">// arg1</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="w">              </span><span class="c1">// arg2</span>
<span class="w">    </span><span class="nf">br</span><span class="w">  </span><span class="no">x18</span>
<span class="nf">ENDPROC</span><span class="p">(</span><span class="no">__cpu_soft_restart</span><span class="p">)</span>

<span class="na">.popsection</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>line</th>
<th>instruction</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>16</td>
<td><code>.pushsection    .idmap.text, "awx"</code></td>
<td>As I mentioned earlier, this routine has to be pushed into <code>idmap.text</code> section. Because it is going to disable MMU.</td>
</tr>
<tr>
<td>34-38</td>
<td><code>mrs     x12, sctlr_el1</code><br/><code>ldr     x13, =SCTLR_ELx_FLAGS</code><br/><code>bic     x12, x12, x13</code><br/><code>pre_disable_mmu_workaround</code><br/><code>msr     sctlr_el1, x12</code></td>
<td>Disable I,D cache and MMU</td>
</tr>
<tr>
<td>45-49</td>
<td><code>mov     x18, x1</code><br/><code>mov     x0, x2</code><br/><code>mov     x1, x3</code><br/><code>mov     x2, x4</code><br/><code>br      x18</code></td>
<td>Set arguments and jump to <code>arm64_relocate_new_kernel routine</code>. In arm64 registers <code>x0</code>-<code>x6</code> are corresponding to first 7 arguments</td>
</tr>
</tbody>
</table>
<h4 id="arm64_relocate_new_kernel"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#arm64_relocate_new_kernel">arm64_relocate_new_kernel()</a></h4>
<p>The assembly routine can be found at <code>arch/arm64/kernel/relocate_kernel.S +29</code>. It does nothing significant. It sets dtb address at <code>x0</code> and jumps to <code>kexec_image-&gt;entry</code> which is [supposed to be] pointing to the new kernel.</p>
<p><br/></p>
<h2 id="kexec-load-kernel-path"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#kexec-load-kernel-path">kexec load kernel path</a></h2>
<p>As I expected if <code>kexec_image-&gt;entry</code> pointed to new kernel, I shouldn't had seen that delay. So to verify that I went through <code>kexec_load()</code> system call's path.</p>
<h4 id="kexec_load"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#kexec_load">kexec_load()</a></h4>
<p><div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="mi">232</span>
<span class="o">---</span>
<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">kexec_load</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">nr_segments</span><span class="p">,</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">kexec_segment</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">segments</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kexec_load_check</span><span class="p">(</span><span class="n">nr_segments</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Verify we are on the appropriate architecture */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEXEC_ARCH_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">KEXEC_ARCH</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEXEC_ARCH_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">KEXEC_ARCH_DEFAULT</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Because we write directly to the reserved memory</span>
<span class="cm">     * region when loading crash kernels we need a mutex here to</span>
<span class="cm">     * prevent multiple crash  kernels from attempting to load</span>
<span class="cm">     * simultaneously, and to prevent a crash kernel from loading</span>
<span class="cm">     * over the top of a in use crash kernel.</span>
<span class="cm">     *</span>
<span class="cm">     * KISS: always take the mutex.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_mutex</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_kexec_load</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">nr_segments</span><span class="p">,</span><span class="w"> </span><span class="n">segments</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
It first checks permission with <code>kexec_load_check</code> function. Then it takes the <code>kexec_mutex</code> and goes into <code>do_kexec_load()</code></p>
<h4 id="do_kexec_load"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#do_kexec_load">do_kexec_load()</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="mi">106</span>
<span class="o">---</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">do_kexec_load</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_segments</span><span class="p">,</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">kexec_segment</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">segments</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kimage</span><span class="w"> </span><span class="o">**</span><span class="n">dest_image</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">image</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEXEC_ON_CRASH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dest_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kexec_crash_image</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kexec_crash_image</span><span class="p">)</span>
<span class="w">            </span><span class="n">arch_kexec_unprotect_crashkres</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dest_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kexec_image</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr_segments</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Uninstall image */</span>
<span class="w">        </span><span class="n">kimage_free</span><span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="n">dest_image</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEXEC_ON_CRASH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Loading another kernel to switch to if this one</span>
<span class="cm">         * crashes.  Free any current crash dump kernel before</span>
<span class="cm">         * we corrupt it.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">kimage_free</span><span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_crash_image</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kimage_alloc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">nr_segments</span><span class="p">,</span><span class="w"> </span><span class="n">segments</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEXEC_PRESERVE_CONTEXT</span><span class="p">)</span>
<span class="w">        </span><span class="n">image</span><span class="o">-&gt;</span><span class="n">preserve_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">machine_kexec_prepare</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Some architecture(like S390) may touch the crash memory before</span>
<span class="cm">     * machine_kexec_prepare(), we must copy vmcoreinfo data after it.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kimage_crash_copy_vmcoreinfo</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_segments</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kimage_load_segment</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">kimage_terminate</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Install the new kernel and uninstall the old */</span>
<span class="w">    </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xchg</span><span class="p">(</span><span class="n">dest_image</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">);</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEXEC_ON_CRASH</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">kexec_crash_image</span><span class="p">)</span>
<span class="w">        </span><span class="n">arch_kexec_protect_crashkres</span><span class="p">();</span>

<span class="w">    </span><span class="n">kimage_free</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>line</th>
<th>code</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>113-120</td>
<td>10-17</td>
<td>Its a simple if block choosing image based on context</td>
</tr>
<tr>
<td>135</td>
<td><code>ret = kimage_alloc_init(&amp;image, entry, nr_segments, segments, flags);</code></td>
<td>Create a new image segment. <b>The second argument is important. This jump address.</b></td>
</tr>
<tr>
<td>142</td>
<td><code>ret = machine_kexec_prepare(image);</code></td>
<td>Check whether any other CPUs are stuck</td>
</tr>
<tr>
<td>154-158</td>
<td>52-57</td>
<td>Copies segments passed from user space to kernel space.</td>
</tr>
<tr>
<td>163</td>
<td><code>image = xchg(dest_image, image);</code></td>
<td>Replaces the older image with new one</td>
</tr>
</tbody>
</table>
<p><br/>
The <code>entry</code> argument passed to <code>kexec_alloc_init()</code> function is assigned to <code>kexec_image-&gt;start</code>.
<div class="highlight"><pre><span></span><code><span class="n">kernel</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">kexec_alloc_init</span><span class="w"> </span><span class="o">+</span><span class="mi">60</span>
<span class="o">---</span>
<span class="n">image</span><span class="o">-&gt;</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
</code></pre></div>
This <code>kexec_image-&gt;start</code> is passed to <code>cpu_soft_restart()</code> as the third argument. If you follow the argument flow in kernel reboot path [as explained above], <code>arm64_relocate_new_kernel()</code> jumps to this address. So this must be the address of new kernel.
<br/></p>
<h2 id="kexec-tools"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#kexec-tools">kexec-tools</a></h2>
<p>Now I went into <code>kexec-tools</code> source. Call to <code>kexec_load()</code> is as below.
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">kexec</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">my_load</span><span class="w"> </span><span class="o">+</span><span class="mi">821</span>
<span class="o">---</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kexec_load</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">entry</span><span class="p">,</span>
<span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="n">nr_segments</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">segment</span><span class="p">,</span>
<span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="n">kexec_flags</span><span class="p">);</span>
</code></pre></div>
<code>info.entry</code> is passed as the first argument. As we've seen in previous section, this the jump address. Lets see what is there in <code>info.entry</code>. The code flow goes like this</p>
<p><div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">+</span><span class="mi">1551</span>
<span class="o">---</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_load</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">fileind</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span>
<span class="w">                </span><span class="n">kexec_flags</span><span class="p">,</span><span class="w"> </span><span class="n">skip_checks</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">kexec</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">my_load</span><span class="w"> </span><span class="o">+</span><span class="mi">772</span>
<span class="o">---</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">load</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_buf</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm</span><span class="o">/</span><span class="n">kexec</span><span class="o">-</span><span class="n">arm</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="mi">82</span>
<span class="o">---</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">file_type</span><span class="w"> </span><span class="n">file_type</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* uImage is probed before zImage because the latter also accepts</span>
<span class="cm">       uncompressed images. */</span>
<span class="w">    </span><span class="p">{</span><span class="s">&quot;uImage&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">uImage_arm_probe</span><span class="p">,</span><span class="w"> </span><span class="n">uImage_arm_load</span><span class="p">,</span><span class="w"> </span><span class="n">zImage_arm_usage</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="s">&quot;zImage&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">zImage_arm_probe</span><span class="p">,</span><span class="w"> </span><span class="n">zImage_arm_load</span><span class="p">,</span><span class="w"> </span><span class="n">zImage_arm_usage</span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kexec</span><span class="o">-</span><span class="n">zImage</span><span class="o">-</span><span class="n">arm64</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">zImage_arm64_load</span><span class="w"> </span><span class="o">+</span><span class="mi">212</span>
<span class="o">---</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arm64_load_other_segments</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_segment</span>
<span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">arm64_mem</span><span class="p">.</span><span class="n">text_offset</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kexec</span><span class="o">-</span><span class="n">arm64</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">arm64_load_other_segments</span><span class="w"> </span><span class="o">+</span><span class="mi">743</span>
<span class="o">---</span>
<span class="w">    </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">elf_rel_get_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rhdr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;purgatory_start&quot;</span><span class="p">);</span>
</code></pre></div></p>
<p>Address of a symbol called <code>purgatory_start</code> is assigned to <code>info-&gt;entry</code>. So <b>old kernel makes a jump to this <code>purgatory_start</code> not to the new kernel.</b> This was the big surprise. The last thing I expected was <code>kexec-tools</code> inserts a piece of code between kernels. I felt that I came close to the criminal.</p>
<h2 id="the-purgatory"><a class="toclink" href="../../2020/01/20/kexec---a-travel-to-the-purgatory/#the-purgatory">The purgatory</a></h2>
<p><div class="highlight"><pre><span></span><code><span class="nf">purgatory</span><span class="err">/</span><span class="no">arch</span><span class="err">/</span><span class="no">arm64</span><span class="err">/</span><span class="no">entry.S</span><span class="w"> </span><span class="err">+</span><span class="mi">9</span>
<span class="err">---</span>
<span class="na">.text</span>

<span class="na">.globl</span><span class="w"> </span><span class="no">purgatory_start</span>
<span class="nl">purgatory_start:</span>

<span class="w">    </span><span class="nf">adr</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="no">.Lstack</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">x19</span>

<span class="w">    </span><span class="nf">bl</span><span class="w">  </span><span class="no">purgatory</span>

<span class="w">    </span><span class="cm">/* Start new image. */</span>
<span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x17</span><span class="p">,</span><span class="w"> </span><span class="no">arm64_kernel_entry</span>
<span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">arm64_dtb_addr</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">xzr</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">xzr</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">xzr</span>
<span class="w">    </span><span class="nf">br</span><span class="w">  </span><span class="no">x17</span>

<span class="nf">size</span><span class="w"> </span><span class="no">purgatory_start</span>
</code></pre></div>
<code>purgatory_start</code> is an assembly subroutine. It calls a function <code>purgatory</code> first. And then stores <code>arm64_dtb_addr</code> in register <code>x0</code> and jumps to <code>arm64_kernel_entry</code>. As arm64 kernel expects dtb address to be set in register <code>x0</code>, this jump is likely to be the jump to new kernel. We'll see where these symbols are set.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">kexec</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kexec</span><span class="o">-</span><span class="n">arm64</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">arm64_load_other_segments</span><span class="w"> </span><span class="o">+</span>
<span class="o">---</span>
<span class="w">    </span><span class="n">elf_rel_build_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rhdr</span><span class="p">,</span><span class="w"> </span><span class="n">purgatory</span><span class="p">,</span><span class="w"> </span><span class="n">purgatory_size</span><span class="p">,</span>
<span class="w">        </span><span class="n">hole_min</span><span class="p">,</span><span class="w"> </span><span class="n">hole_max</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">elf_rel_get_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rhdr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;purgatory_start&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">elf_rel_set_symbol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rhdr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;arm64_kernel_entry&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">image_base</span><span class="p">,</span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="n">image_base</span><span class="p">));</span>

<span class="w">    </span><span class="n">elf_rel_set_symbol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rhdr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;arm64_dtb_addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtb_base</span><span class="p">,</span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dtb_base</span><span class="p">));</span>
</code></pre></div>
As you see in the code snippet, <code>image_base</code> is <code>arm64_kernel_entry</code> and <code>dtb_base</code> is <code>arm64_dtb_addr</code>. If you go little above in the function, you'll see <code>image_base</code> and <code>dtb_base</code> are kernel address and device-tree address respectively. And the function <code>purgatory</code> is also loaded into the segments. The last function to check between two kernels is <code>purgatory</code>.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">purgatory</span><span class="o">/</span><span class="n">purgatory</span><span class="p">.</span><span class="n">c</span>
<span class="o">---</span>
<span class="kt">void</span><span class="w"> </span><span class="n">purgatory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I&#39;m in purgatory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">setup_arch</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip_checks</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">verify_sha256_digest</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* loop forever */</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">post_verification_setup_arch</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<code>setup_arch()</code> and <code>post_verification_setup_arch()</code> are no-op for arm64. The actual delay is caused by <code>verify_sha256_digest()</code>. There is nothing wrong with this function. But it is being executed with I and D caches off. The option <code>skip_checks</code> was not introduced by the time I was debugging this issue. So we solved it by enabling I &amp; D cache in <code>setup_arch()</code> and disabling it back in <code>post_verification_setup_arch()</code>.</p>
<p>At last I felt like my purgatory sentence was over.</p>
<div class="flex">
        <script src="https://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
        <script type="IN/Share" data-url="https://eastrivervillage.com/blog/2020/01/20/kexec---a-travel-to-the-purgatory/"></script>
    </div>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../8/">8</a> <a class="md-pagination__link" href="../9/">9</a> <span class="md-pagination__current">10</span> <a class="md-pagination__link" href="../11/">11</a> <a class="md-pagination__link" href="../12/">12</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../27/">27</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://www.linkedin.com/in/balakumaran-kannan/" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/0xba1a" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.indexes", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>